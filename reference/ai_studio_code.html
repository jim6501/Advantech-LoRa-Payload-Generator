<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advantech Payload Formatter v4.5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0f1115;
            --bg-sidebar: #161b22;
            --bg-card: #1c2128;
            --bg-input: #0d1117;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-color: #2f81f7;
            --code-color: #a5d6ff;
        }

        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { background-color: var(--bg-sidebar); min-height: 100vh; border-right: 1px solid var(--border-color); position: fixed; width: 250px; z-index: 10; }
        .nav-item { padding: 12px 20px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .nav-item:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .nav-item.active { background: rgba(47, 129, 247, 0.15); color: var(--accent-color); border-right: 3px solid var(--accent-color); }
        .nav-item i { width: 25px; }

        /* Content */
        .main-content { margin-left: 250px; padding: 30px; }
        .custom-card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
        .card-header { border-bottom: 1px solid var(--border-color); padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; }

        /* Inputs & Outputs */
        .form-control, .form-select { 
            background-color: var(--bg-input); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            font-family: 'JetBrains Mono', monospace; 
            transition: 0.2s;
        }
        .form-control:focus, .form-select:focus { 
            background-color: var(--bg-input); 
            border-color: var(--accent-color); 
            color: var(--text-primary); 
            box-shadow: none; 
        }

        /* --- FIXED: Disabled State Styles --- */
        .form-control:disabled, .form-select:disabled, input:disabled {
            background-color: rgba(255, 255, 255, 0.08) !important; /* Slightly lighter bg */
            color: #ffffff !important; /* Bright White Text */
            border-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.8; /* Slight transparency */
        }

        .input-group-text { background-color: #21262d; border-color: var(--border-color); color: var(--text-secondary); }
        .fmt-select { max-width: 80px; font-size: 0.85em; font-weight: bold; color: var(--accent-color); }

        /* Helper Text & Hints */
        .form-text, .text-muted, #chHint { color: #aeb6be !important; } /* Make hints brighter */

        pre, .gen-output { background-color: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); color: var(--code-color); font-family: 'JetBrains Mono', monospace; word-break: break-all; }
        .gen-output { color: #7ee787; font-size: 1.2rem; font-weight: bold; }

        /* Structure Badges */
        .struct-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; padding: 5px 8px; margin-right: 4px; border-radius: 4px; display: inline-block; margin-bottom: 4px;}
        .sb-header { background: rgba(210, 153, 34, 0.2); color: #d29922; border: 1px solid rgba(210, 153, 34, 0.4); }
        .sb-type { background: rgba(47, 129, 247, 0.2); color: #58a6ff; border: 1px solid rgba(47, 129, 247, 0.4); }
        .sb-len { background: rgba(110, 118, 129, 0.2); color: #8b949e; border: 1px solid rgba(110, 118, 129, 0.4); }
        .sb-cmd { background: rgba(247, 129, 102, 0.2); color: #ff7b72; border: 1px solid rgba(247, 129, 102, 0.4); }
        .sb-data { background: rgba(63, 185, 80, 0.2); color: #3fb950; border: 1px solid rgba(63, 185, 80, 0.4); }
        .sb-crc { background: rgba(163, 113, 247, 0.2); color: #d2a8ff; border: 1px solid rgba(163, 113, 247, 0.4); }

        /* UI Elements */
        .grid-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .feature-check { display: none; }
        .feature-label { 
            text-align: left; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; 
            font-size: 0.9em; cursor: pointer; color: var(--text-secondary); background: var(--bg-input); transition: 0.2s;
            display: flex; align-items: center;
        }
        .feature-label:hover { border-color: var(--accent-color); color: var(--text-primary); }
        .feature-check:checked + .feature-label { background: rgba(47, 129, 247, 0.15); color: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 0 8px rgba(47, 129, 247, 0.2); }
        
        .weekday-selector { display: flex; gap: 5px; justify-content: space-between; }
        .weekday-check { display: none; }
        .weekday-label { flex: 1; text-align: center; padding: 6px 0; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8em; cursor: pointer; color: var(--text-secondary); background: var(--bg-input); }
        .weekday-check:checked + .weekday-label { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* Utilities */
        .btn-primary { background-color: var(--accent-color); border: none; }
        .btn-primary:hover { background-color: #266dd3; }
        .text-accent { color: var(--accent-color); }
        .json-key { color: #ff7b72; } .json-string { color: #a5d6ff; } .json-number { color: #79c0ff; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="p-4 mb-2 border-bottom border-secondary" style="border-color: #30363d !important;">
        <h5 class="m-0 fw-bold text-white" style="font-size: 1.1rem;"><i class="fa-solid fa-satellite-dish me-2"></i>Payload Formatter</h5>
        <small class="text-secondary">v4.5 (High Contrast)</small>
    </div>
    <div class="nav-item active" onclick="switchTab('uplink')" id="nav-uplink">
        <i class="fa-solid fa-arrow-up"></i> Uplink Parser
    </div>
    <div class="nav-item" onclick="switchTab('downlink')" id="nav-downlink">
        <i class="fa-solid fa-paper-plane"></i> Downlink Gen
    </div>
</div>

<div class="main-content">
    
    <!-- Uplink Parser -->
    <div id="view-uplink">
        <h3 class="mb-4">Uplink Payload Parser</h3>
        <div class="row">
            <div class="col-lg-5">
                <div class="custom-card mb-4">
                    <div class="card-header">Input</div>
                    <div class="card-body">
                        <label class="text-secondary mb-2">Hex String</label>
                        <textarea class="form-control" id="upHexInput" rows="6" placeholder="811C40..."></textarea>
                        <button class="btn btn-primary w-100 mt-3" onclick="runParser()">Parse</button>
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="loadUpExample()">Load Example</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="custom-card h-100">
                    <div class="card-header">
                        JSON Result
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyText('upOutput')">Copy</button>
                    </div>
                    <div class="card-body p-0">
                        <pre id="upOutput" class="h-100 border-0 rounded-0 m-0">Waiting...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Downlink Generator -->
    <div id="view-downlink" style="display: none;">
        <h3 class="mb-4">Downlink Generator</h3>
        <div class="row">
            <div class="col-lg-5">
                <div class="custom-card h-100">
                    <div class="card-header">Configuration</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-secondary mb-2">1. Category</label>
                            <select class="form-select" id="genType" onchange="updateGenCommands()">
                                <option value="0x5" selected>Sensor (Temp/Accel) [0x5]</option>
                                <option value="0x6">Device (System/RTC) [0x6]</option>
                                <option value="0x8">RS-485 Register [0x8]</option>
                                <option value="0x7">RS-485 Coil [0x7]</option>
                                <option value="0x0">DI (Digital Input) [0x0]</option>
                                <option value="0x1">DO (Digital Output) [0x1]</option>
                                <option value="0x3">AI (Analog Input) [0x3]</option>
                            </select>
                        </div>
                        
                        <!-- Sub-Type Selectors -->
                        <div class="mb-3" id="sensorRangeGroup">
                            <label class="text-secondary mb-2">Sensor Range</label>
                            <select class="form-select" id="sensorRange" onchange="updateGenCommands()">
                                <option value="0">Temperature / Humidity (0x0-0x3)</option>
                                <option value="4">Accelerometer / Vibration (0x4-0x5)</option>
                            </select>
                        </div>

                        <!-- RS-485 Specifics -->
                        <div class="row g-2 mb-3" id="portGroup" style="display:none;">
                            <div class="col-6">
                                <label class="text-secondary mb-2">COM Port</label>
                                <select class="form-select" id="genPort">
                                    <option value="0">Port 1</option>
                                    <option value="1">Port 2</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="text-secondary mb-2">Channel/Rule</label>
                                <input type="number" class="form-control" id="genCh485" value="0" min="0" max="127">
                            </div>
                        </div>

                        <!-- Standard Channel -->
                        <div class="mb-3" id="channelGroup">
                            <label class="text-secondary mb-2">Channel</label>
                            <input type="number" class="form-control" id="genCh" value="0" min="0" max="15">
                            <div class="form-text small" id="chHint"></div>
                        </div>

                        <!-- Axis Selection (Accel) -->
                        <div class="mb-3" id="axisGroup" style="display:none;">
                            <label class="text-secondary mb-2">Target Axes (Generates Mask)</label>
                            <div class="d-flex gap-3">
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="axisX" checked><label class="form-check-label text-light">X</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="axisY" checked><label class="form-check-label text-light">Y</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="axisZ" checked><label class="form-check-label text-light">Z</label></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="text-secondary mb-2">2. Command</label>
                            <select class="form-select" id="genCmd" onchange="updateGenParams()"></select>
                        </div>

                        <div id="genParamArea" class="mb-4"></div>

                        <div class="border-top border-secondary pt-3 mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="text-secondary m-0">Sequence No.</label>
                                <input type="number" class="form-control form-control-sm w-25" id="genSeq" value="0">
                            </div>
                        </div>

                        <button class="btn btn-primary w-100 mt-2" onclick="runGenerator()">Generate Hex</button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-7">
                <div class="custom-card">
                    <div class="card-header">
                        Output
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyText('genOutput')">Copy</button>
                    </div>
                    <div class="card-body py-4">
                        <label class="text-secondary mb-2">Protocol Structure</label>
                        <div id="genStructure" class="mb-3">
                            <span class="text-muted small">Select parameters and click Generate...</span>
                        </div>

                        <label class="text-secondary mb-2">Generated Hex String</label>
                        <div class="gen-output mb-3" id="genOutput">Waiting...</div>
                        
                        <div class="border-top border-secondary pt-3 text-start">
                            <label class="text-secondary small mb-2">Breakdown:</label>
                            <div class="text-secondary small font-monospace" id="genBreakdown"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Buffer Reader ---
    class BufferReader { constructor(i){if(Array.isArray(i))this.b=i;else if(typeof i==='string'){let m=i.replace(/\s+/g,'').match(/.{1,2}/g);this.b=m?m.map(x=>parseInt(x,16)):[]}else this.b=[];this.p=0}rU8(){return this.b[this.p++]||0}rU16(){let v=this.b[this.p]|(this.b[this.p+1]<<8);this.p+=2;return v}rU32(){let v=(this.b[this.p]|(this.b[this.p+1]<<8)|(this.b[this.p+2]<<16)|(this.b[this.p+3]<<24))>>>0;this.p+=4;return v}rB(n){let r=this.b.slice(this.p,this.p+n);this.p+=n;return r}left(){return this.p<this.b.length} }

    // --- Uplink Logic ---
    function runParser() {
        let hex=document.getElementById('upHexInput').value.trim(); if(!hex)return;
        let r=new BufferReader(hex), res={header:{},payloads:[]};
        try {
            let fc=r.rU8(), seq=r.rU8(); res.header={fc:"0x"+fc.toString(16).toUpperCase(),seq};
            if(fc&0x80) res.header.totalLen=r.rU8();
            let am=(fc>>2)&3; if(am===1)res.header.addr=Array.from(r.rB(2),b=>b.toString(16).padStart(2,'0')).join('');
            if(am===2)res.header.addr=Array.from(r.rB(8),b=>b.toString(16).padStart(2,'0')).join('');
            
            while(r.left() && r.p < r.b.length-1) { // Reserve CRC
                let tb=r.rU8(), ioT=(tb>>4)&0xF, ioR=tb&0xF;
                let len=(ioT===0xA)?r.rU16():r.rU8();
                let dat=r.rB(len), sub=new BufferReader(dat);
                let seg={type:`0x${ioT.toString(16).toUpperCase()}`};
                
                if(ioT===5){ seg.desc=(ioR<4)?"Sensor (Temp/Hum)":"Sensor (Accel)";
                    let m=sub.rU8(); if(ioR<4 && (m&4)){let v=sub.rU32(); if(v&0x80000000)v-=0x100000000; seg.val=(v/1000).toFixed(2);}
                    else if(ioR>=4){seg.axes={}; [{b:7,n:'X'},{b:6,n:'Y'},{b:5,n:'Z'}].forEach(ax=>{if((m>>ax.b)&1){let sm=sub.rU8(),s={}; if(sm&1)s.Vel=(sub.rU16()/100).toFixed(2); if(sm&2)s.Peak=sub.rU16(); seg.axes[ax.n]=s;}});}
                } else if(ioT===6){ seg.desc="Device"; let m=sub.rU8(); if(m&4)seg.bat=sub.rU8()+"%"; }
                res.payloads.push(seg);
            }
            if(r.left()) res.crc=r.rU8().toString(16).toUpperCase();
        } catch(e){res.error=e.message}
        document.getElementById('upOutput').innerHTML=JSON.stringify(res,null,2).replace(/"/g,'').replace(/,/g,'');
    }

    // --- Downlink Definitions (v4.5) ---
    const GEN_DEFS = {
        "0x0": { 
            "1": { name: "Start/Stop Counter", type: "select", opts: {1:"Start", 0:"Stop"}, len: 1, cmdId: 1 },
            "2": { name: "Get/Clear Overflow", type: "select", opts: {0:"Clear"}, len: 1, cmdId: 2 },
            "3": { name: "Clear Counter", type: "fixed", val: 1, len: 1, cmdId: 3 },
            "4": { name: "Get/Clear L2H Latch", type: "select", opts: {0:"Clear"}, len: 1, cmdId: 4 },
            "5": { name: "Get/Clear H2L Latch", type: "select", opts: {0:"Clear"}, len: 1, cmdId: 5 },
            "6": { name: "Set Conv. Interval", type: "number", unit: "sec", scale: 1, len: 4, cmdId: 6, desc: "Data Updating Interval" }
        },
        "0x1": { 
            "1": { name: "Set Signal Logic", type: "select", opts: {1:"High", 0:"Low"}, len: 1, cmdId: 1 },
            "2": { name: "Set Pulse Mode", type: "select", opts: {1:"Enable", 0:"Disable"}, len: 1, cmdId: 2 },
            "3": { name: "Stop Pulse", type: "fixed", val: 1, len: 1, cmdId: 3 }
        },
        "0x3": { 
            "1": { name: "Clear High Alarm", type: "fixed", val: 0, len: 1, cmdId: 1 },
            "2": { name: "Clear Low Alarm", type: "fixed", val: 0, len: 1, cmdId: 2 },
            "3": { name: "Clear Max Value", type: "fixed", val: 1, len: 1, cmdId: 3 },
            "4": { name: "Clear Min Value", type: "fixed", val: 1, len: 1, cmdId: 4 },
            "5": { name: "Set Conv. Interval", type: "number", unit: "sec", scale: 1, len: 4, cmdId: 5 }
        },
        "0x5_0": { 
            "5": { name: "Set High Alarm", type: "float", scale: 1000, len: 4, desc: "Value * 1000 (e.g. 25.5 -> 25500)", cmdId: 5 },
            "6": { name: "Set Low Alarm", type: "float", scale: 1000, len: 4, desc: "Value * 1000", cmdId: 6 },
            "7": { name: "Set Offset", type: "float", scale: 1000, len: 4, desc: "Value * 1000", cmdId: 7 }
        },
        "0x5_4": { 
            "5": { name: "Set High Alarm (RMS)", type: "float", scale: 100, len: 4, desc: "Value * 100 (e.g. 15.25 -> 1525)", cmdId: 5 },
            "9": { name: "Get Log (Index)", type: "number", len: 4, desc: "Log Index (0xFFFFFFFF = Latest)", cmdId: 9 },
            "10": { name: "Read Log Part", type: "composite", parts: [{id:"idx",type:"number",len:4,label:"Idx"},{id:"n",type:"number",len:2,label:"n"},{id:"k",type:"number",len:2,label:"K"}], cmdId: 10 },
            "11": { name: "Get Log (UTC)", type: "composite", parts: [{id:"idx",type:"number",len:4,label:"Idx"},{id:"utc",type:"datetime",len:4,label:"UTC"}], cmdId: 11 },
            "12": { name: "Features Enable", type: "bitmask", len: 2, options: [{b:0,l:"Kurtosis"},{b:1,l:"Crest Factor"},{b:2,l:"Skewness"},{b:3,l:"Std Deviation"},{b:4,l:"Displacement"}], desc: "Select features to enable:", cmdId: 12 },
            "14": { name: "Clear Log Cmds", type: "fixed", val: 0, len: 0, cmdId: 14 },
            "15": { name: "Get Log (Freq)", type: "composite", parts: [{id:"idx",type:"number",len:4,label:"Idx"},{id:"utc",type:"datetime",len:4,label:"UTC"},{id:"fstart",type:"number",len:4,label:"F-Start"},{id:"fend",type:"number",len:4,label:"F-End"}], cmdId: 15 }
        },
        "0x6": { 
            "61_1": { name: "[0x61] Adjust RTC (UNIX)", type: "datetime", len: 4, subType: 1, cmdId: 1 },
            "61_2": { name: "[0x61] Adjust RTC (ISO)", type: "string", len: 20, desc: "YYYY-MM-DDThh:mm:ssZ", subType: 1, cmdId: 2 },
            "61_3": { name: "[0x61] Restart (RST)", type: "fixed_hex", hex: "525354", len: 3, subType: 1, cmdId: 3 },
            "61_4": { name: "[0x61] Adjust RTC Offset", type: "number", unit: "sec", len: 4, subType: 1, cmdId: 4, desc: "Signed Int (+/- Seconds)" },
            "61_5": { name: "[0x61] Query FW Ver", type: "fixed", val: 0, len: 1, subType: 1, cmdId: 5 },
            "62_1": { name: "[0x62] Update Interval", type: "number", unit: "sec", len: 4, subType: 2, cmdId: 1, desc: "Global Update Interval" },
            "62_2": { name: "[0x62] Schedule", type: "schedule", len: 10, subType: 2, cmdId: 2 },
            "63_1": { name: "[0x63] Set Class", type: "select", opts: {1:"Class A", 3:"Class C"}, len: 1, subType: 3, cmdId: 1 }
        },
        "0x8": { 
            "1": { name: "Set Register Value", type: "number", len: 2, desc: "Value (0~65535)", cmdId: 1 },
            "128": { name: "Config Scan Interval", type: "composite", parts: [{id:"mask",type:"number",len:4,label:"Rule Mask (4 Bytes)"},{id:"int",type:"number",len:4,label:"Interval (sec)"}], cmdId: 0x80 }
        },
        "0x7": { 
            "1": { name: "Write Coil", type: "select", opts: {1:"ON", 0:"OFF"}, len: 1, cmdId: 1 },
            "128": { name: "Config Scan Interval", type: "composite", parts: [{id:"mask",type:"number",len:4,label:"Rule Mask (4 Bytes)"},{id:"int",type:"number",len:4,label:"Interval (sec)"}], cmdId: 0x80 }
        }
    };

    function updateGenCommands() {
        let type = document.getElementById('genType').value;
        let rangeGroup = document.getElementById('sensorRangeGroup');
        let chGroup = document.getElementById('channelGroup');
        let axisGroup = document.getElementById('axisGroup');
        let portGroup = document.getElementById('portGroup');
        let chInput = document.getElementById('genCh');
        let chHint = document.getElementById('chHint');
        let sel = document.getElementById('genCmd');
        
        sel.innerHTML = "";
        rangeGroup.style.display = 'none';
        axisGroup.style.display = 'none';
        portGroup.style.display = 'none';
        
        // Reset Channel State
        chGroup.style.display = 'block';
        chInput.disabled = false;
        chHint.innerText = "";

        if (type === "0x5") {
            rangeGroup.style.display = 'block';
            let range = document.getElementById('sensorRange').value;
            type = (range === "0") ? "0x5_0" : "0x5_4";
            
            if (type === "0x5_4") {
                chGroup.style.display = 'none';
                axisGroup.style.display = 'block';
            } else {
                chHint.innerText = "Target Channel (Generates Mask Byte)";
            }
        } else if (type === "0x6") {
            chInput.disabled = true;
            chInput.value = "0";
            chHint.innerText = "Not used for Device commands";
        } else if (type === "0x7" || type === "0x8") {
            chGroup.style.display = 'none';
            portGroup.style.display = 'flex';
        }

        let defs = GEN_DEFS[type];
        if(defs) {
            for(let k in defs) {
                let opt = document.createElement("option");
                opt.value = k;
                opt.text = defs[k].name;
                sel.appendChild(opt);
            }
        }
        sel.setAttribute('data-real-type', type);
        updateGenParams();
    }

    function updateGenParams() {
        let type = document.getElementById('genCmd').getAttribute('data-real-type');
        let cmdKey = document.getElementById('genCmd').value;
        let div = document.getElementById('genParamArea');
        div.innerHTML = "";
        
        let conf = GEN_DEFS[type] ? GEN_DEFS[type][cmdKey] : null;
        if(!conf) return;

        if(conf.type === 'bitmask') {
            div.innerHTML = `<label class="text-secondary small mb-2">${conf.desc}</label><div class="grid-selector">` + 
                conf.options.map(o => `
                    <input type="checkbox" id="bm_${o.b}" class="feature-check" value="${o.b}">
                    <label for="bm_${o.b}" class="feature-label"><i class="fa-solid fa-check me-2"></i>${o.l}</label>
                `).join('') + `</div>`;
            return;
        }

        if(conf.type === 'schedule') { div.innerHTML = renderScheduleUI(); return; }
        
        if(conf.type === 'composite') {
            let html = `<label class="text-accent mb-2 small">Parameters:</label>`;
            conf.parts.forEach(p => {
                html += `<div class="mb-2"><label class="text-secondary small">${p.label}</label>`;
                if(p.type==='datetime') html += `<input type="datetime-local" id="comp_${p.id}" class="form-control form-control-sm">`;
                else {
                    html += `<div class="input-group input-group-sm"><select class="input-group-text fmt-select" id="fmt_comp_${p.id}"><option value="dec">DEC</option><option value="hex">HEX</option></select><input type="text" id="comp_${p.id}" class="form-control" placeholder="Val"></div>`;
                }
                html += `</div>`;
            });
            div.innerHTML = html;
            initDates();
            return;
        }

        let html = `<label class="text-secondary mb-1">${conf.name}</label>`;
        if(conf.type === 'fixed_hex') html += `<input class="form-control" disabled value="${conf.hex}">`;
        else if(conf.type === 'fixed') html += `<input class="form-control" disabled value="Empty Payload">`;
        else if(conf.type === 'select') {
            html += `<select id="genVal" class="form-select">`;
            for(let k in conf.opts) html += `<option value="${k}">${conf.opts[k]}</option>`;
            html += `</select>`;
        } else if(conf.type === 'string') {
            html += `<input type="text" class="form-control" id="genVal" placeholder="${conf.desc}">`;
        } else if(conf.type === 'float') {
            html += `<div class="input-group"><input type="number" step="0.01" class="form-control" id="genVal" placeholder="Value"><span class="input-group-text">x${conf.scale}</span></div>`;
        } else if(conf.type === 'number') {
            html += `<div class="input-group"><select class="input-group-text fmt-select" id="fmt_genVal"><option value="dec">DEC</option><option value="hex">HEX</option></select><input type="text" class="form-control" id="genVal" placeholder="Value">${conf.unit ? `<span class="input-group-text">${conf.unit}</span>` : ''}</div>`;
        } else if(conf.type === 'datetime') {
            html += `<input type="datetime-local" class="form-control" id="genVal">`;
        }
        
        if(conf.desc) html += `<div class="text-muted small mt-2"><i class="fa-solid fa-circle-info me-1"></i>${conf.desc}</div>`;
        div.innerHTML = html;
        if(conf.type === 'datetime') initDates();
    }

    function renderScheduleUI() {
        return `<div class="mb-2"><select id="schMode" class="form-select"><option value="0">Basic</option><option value="1">Advance</option></select></div><div class="mb-2"><div class="weekday-selector">${['S','M','T','W','T','F','S'].map((d,i)=>`<input type="checkbox" id="d${i}" class="weekday-check"><label for="d${i}" class="weekday-label">${d}</label>`).join('')}</div></div><div class="row g-2 mb-2"><div class="col-6"><input type="time" id="schStart" class="form-control" value="09:00"></div><div class="col-6"><input type="time" id="schEnd" class="form-control" value="18:00"></div></div><div class="mb-2"><input type="number" id="schInt" class="form-control" placeholder="Interval (sec)" value="600"></div>`;
    }

    function parseInput(valStr, format) {
        if (!valStr) return 0;
        if (format === 'hex') return parseInt(valStr.replace(/^0x/i, ''), 16);
        return parseInt(valStr, 10);
    }

    function initDates() {
        setTimeout(()=>{
            document.querySelectorAll('input[type="datetime-local"]').forEach(el=>{
                if(!el.value) {
                    let now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
                    el.value = now.toISOString().slice(0,16);
                }
            })
        },0);
    }

    function runGenerator() {
        let seq = parseInt(document.getElementById('genSeq').value)||0;
        let typeStr = document.getElementById('genType').value;
        let resolvedType = document.getElementById('genCmd').getAttribute('data-real-type');
        let cmdKey = document.getElementById('genCmd').value;
        let conf = GEN_DEFS[resolvedType][cmdKey];
        let cmdId = conf.cmdId;

        let data = [];

        if(conf.type === 'schedule') {
            data.push(parseInt(document.getElementById('schMode').value));
            let mask = 0; for(let i=0; i<7; i++) if(document.getElementById('d'+i).checked) mask |= (1<<i);
            data.push(mask);
            let s = document.getElementById('schStart').value.split(':'), e = document.getElementById('schEnd').value.split(':');
            data.push(parseInt(s[0]), parseInt(s[1]), parseInt(e[0]), parseInt(e[1]));
            let v = parseInt(document.getElementById('schInt').value);
            let b = new Uint32Array([v]); let u = new Uint8Array(b.buffer);
            data.push(u[0],u[1],u[2],u[3]);
        } 
        else if(conf.type === 'bitmask') {
            let mask = 0; conf.options.forEach(o => { if(document.getElementById('bm_'+o.b).checked) mask |= (1 << o.b); });
            let arr = new Uint16Array([mask]); let buf = new Uint8Array(arr.buffer); data.push(buf[0], buf[1]);
        } 
        else if(conf.type === 'composite') {
            conf.parts.forEach(p => {
                let val = 0;
                if(p.type==='datetime') val = Math.floor(new Date(document.getElementById('comp_'+p.id).value).getTime()/1000);
                else {
                    let fmtEl = document.getElementById('fmt_comp_'+p.id);
                    val = parseInput(document.getElementById('comp_'+p.id).value, fmtEl?fmtEl.value:'dec') || 0;
                }
                let arr = (p.len===2) ? new Uint16Array([val]) : new Uint32Array([val]);
                let buf = new Uint8Array(arr.buffer);
                for(let i=0; i<p.len; i++) data.push(buf[i]);
            });
        } 
        else if(conf.type === 'fixed_hex') {
            data = conf.hex.match(/.{1,2}/g).map(b=>parseInt(b,16));
        }
        else if(conf.type === 'string') {
            let str = document.getElementById('genVal').value;
            for (let i = 0; i < str.length; i++) data.push(str.charCodeAt(i));
        } 
        else if(conf.type !== 'fixed') {
            let raw = document.getElementById('genVal').value;
            let val = 0;
            if(conf.type === 'datetime') val = Math.floor(new Date(raw).getTime()/1000);
            else if(conf.type === 'float') val = Math.round(parseFloat(raw)*conf.scale);
            else {
                let fmtEl = document.getElementById('fmt_genVal');
                val = parseInput(raw, fmtEl?fmtEl.value:'dec');
            }
            let arr;
            if(conf.len===1) arr = new Uint8Array([val]);
            else if(conf.len===2) arr = new Uint8Array(new Int16Array([val]).buffer); 
            else if(conf.len===4) arr = new Uint8Array(new Int32Array([val]).buffer);
            data = Array.from(arr);
        }

        let payload = [];
        let typeVal = parseInt(typeStr);
        let viz="";

        // 1. RS-485
        if(typeStr==="0x7"||typeStr==="0x8"){
            let byte1=(typeVal&0xF)<<4, port=parseInt(document.getElementById('genPort').value), chL=parseInt(document.getElementById('genCh485').value);
            let byteCh=(port<<7)|(chL&0x7F), segLen=1+data.length;
            payload=[byte1, byteCh, segLen, cmdId, ...data];
            viz = `<span class="struct-badge sb-type">Type: 0x${byte1.toString(16)}</span> <span class="struct-badge sb-type">Port|Ch: 0x${byteCh.toString(16)}</span> <span class="struct-badge sb-len">Len: ${segLen}</span> <span class="struct-badge sb-cmd">Cmd: ${cmdId}</span> <span class="struct-badge sb-data">Data [${data.length}]</span>`;
        }
        // 2. Sensor (With Mask Byte Fix)
        else if(typeStr==="0x5"){
            let range=parseInt(document.getElementById('sensorRange').value);
            let byte1=((typeVal&0xF)<<4)|(range&0xF);
            let mask=0;
            if(range===4) { if(document.getElementById('axisX').checked)mask|=0x80; if(document.getElementById('axisY').checked)mask|=0x40; if(document.getElementById('axisZ').checked)mask|=0x20; } 
            else { let ch=parseInt(document.getElementById('genCh').value); mask=(ch&7)<<5; }
            let segLen=1+data.length; 
            payload=[byte1, mask, segLen, cmdId, ...data];
            viz = `<span class="struct-badge sb-type">Type|Rng: 0x${byte1.toString(16)}</span> <span class="struct-badge sb-type">Mask: 0x${mask.toString(16)}</span> <span class="struct-badge sb-len">Len: ${segLen}</span> <span class="struct-badge sb-cmd">Cmd: ${cmdId}</span> <span class="struct-badge sb-data">Data [${data.length}]</span>`;
        }
        // 3. Standard
        else {
            let low=0; if(typeStr==="0x6") low=conf.subType; else low=parseInt(document.getElementById('genCh').value)&0xF;
            let byte1=((typeVal&0xF)<<4)|(low&0xF), segLen=1+data.length;
            payload=[byte1, segLen, cmdId, ...data];
            viz = `<span class="struct-badge sb-type">Type|Ch: 0x${byte1.toString(16)}</span> <span class="struct-badge sb-len">Len: ${segLen}</span> <span class="struct-badge sb-cmd">Cmd: ${cmdId}</span> <span class="struct-badge sb-data">Data [${data.length}]</span>`;
        }

        let crc=0xFF; for(let b of payload){crc^=b;for(let k=0;k<8;k++)crc=(crc&0x80)?((crc<<1)^7):(crc<<1);crc&=0xFF;}
        let head=[0x80,seq,payload.length];
        let full=[...head, ...payload, crc];
        let hex=full.map(b=>b.toString(16).toUpperCase().padStart(2,'0')).join('');

        document.getElementById('genOutput').innerText=hex;
        document.getElementById('genStructure').innerHTML=`<span class="struct-badge sb-header">Header: 80 ${seq.toString(16)} ${payload.length.toString(16)}</span> ` + viz + ` <span class="struct-badge sb-crc">CRC: ${crc.toString(16)}</span>`;
        document.getElementById('genBreakdown').innerText=hex.match(/.{1,2}/g).join(' ');
    }

    function switchTab(t){document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));document.getElementById('nav-'+t).classList.add('active');document.getElementById('view-uplink').style.display=t==='uplink'?'block':'none';document.getElementById('view-downlink').style.display=t==='downlink'?'block':'none';if(t==='downlink')updateGenCommands();}
    function copyText(id){navigator.clipboard.writeText(document.getElementById(id).innerText);}
    function loadUpExample(){document.getElementById('upHexInput').value="811C405008070000000C3200005429E2170000E4011F01CB0046050000CC015A01F500CB0400006601970120016F01030000000073992E6860091B0002940D74992E6877";runParser();}
    function syntaxHighlight(json){ if(typeof json!='string')json=JSON.stringify(json,undefined,2); return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match=>{ var cls='json-number'; if(/^"/.test(match)){if(/:$/.test(match))cls='json-key';else cls='json-string';} return `<span class="${cls}">${match}</span>`; }); }

    updateGenCommands();
</script>
</body>
</html>